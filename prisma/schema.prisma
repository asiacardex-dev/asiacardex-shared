// AsiaCardex Database Schema
// Prisma Schema for PostgreSQL

generator client {
  provider      = "prisma-client-js"
  output        = "../generated/client"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CATALOGUE (Games, Sets, Products)
// ============================================

model Game {
  id        String   @id @default(uuid())
  code      String   @unique // pokemon, yugioh, mtg, onepiece
  name      String
  slug      String   @unique
  imageUrl  String?
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sets     Set[]
  products Product[]

  @@index([code])
  @@index([isActive])
}

model Set {
  id          String    @id @default(uuid())
  gameId      String
  externalId  String?   // ID from external API
  code        String    // Set code (e.g., "SV01")
  name        String
  slug        String
  releaseDate DateTime?
  imageUrl    String?   // Logo URL
  symbolUrl   String?   // Set symbol URL
  totalCards  Int?      // Total unique cards
  officialCardCount Int? // Official card count

  // Series info
  serieId     String?
  serieName   String?

  // Format legality
  legalStandard  Boolean @default(false)
  legalExpanded  Boolean @default(true)

  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  game     Game      @relation(fields: [gameId], references: [id])
  products Product[]

  @@unique([gameId, code])
  @@unique([gameId, slug])
  @@index([gameId])
  @@index([releaseDate])
  @@index([serieId])
}

model Product {
  id             String          @id @default(uuid())
  gameId         String
  setId          String?
  externalId     String?         // ID from external API
  externalSource String?         // tcgdex, ygoprodeck, pokemontcg
  name           String
  nameEn         String?         // English name for search
  slug           String
  number         String?         // Card number in set
  rarity         String?
  category       ProductCategory @default(SINGLE)
  imageUrl       String?
  imageUrlHiRes  String?
  description    String?

  // Pokemon-specific fields (searchable/filterable)
  cardType       String?         // Pokemon, Trainer, Energy
  hp             Int?            // Hit points
  types          Json?           // ["Grass", "Fire"] - Pokemon types
  stage          String?         // Basic, Stage1, Stage2, VMAX, VSTAR
  suffix         String?         // V, VMAX, ex, GX, VSTAR, etc.
  evolvesFrom    String?         // Pokemon name it evolves from
  illustrator    String?         // Card artist
  regulationMark String?         // D, E, F, G... (format identifier)

  // Variants available
  hasHolo        Boolean @default(false)
  hasReverse     Boolean @default(false)
  hasNormal      Boolean @default(false)
  hasFirstEdition Boolean @default(false)

  // Format legality
  legalStandard  Boolean @default(false)
  legalExpanded  Boolean @default(true)

  // Pokedex reference
  dexIds         Json?           // [251] - National dex numbers

  // Market price (from external source) - NOT stored from sync, fetched on-demand
  marketPrice          Decimal?  @db.Decimal(12, 2)
  marketPriceSource    String?
  marketPriceUpdatedAt DateTime?

  // Sync status
  lastSyncedAt DateTime?
  syncStatus   SyncStatus @default(PENDING)
  syncError    String?

  // Metadata (JSON for complex attributes: attacks, abilities, weaknesses, etc.)
  attributes Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  game     Game      @relation(fields: [gameId], references: [id])
  set      Set?      @relation(fields: [setId], references: [id])
  listings Listing[]

  @@unique([externalSource, externalId])
  @@unique([gameId, slug])
  @@index([gameId])
  @@index([setId])
  @@index([name])
  @@index([category])
  @@index([syncStatus])
  @@index([cardType])
  @@index([hp])
  @@index([stage])
  @@index([suffix])
  @@index([regulationMark])
  @@index([illustrator])
  @@index([legalStandard])
}

enum ProductCategory {
  SINGLE
  SEALED
  GRADED
}

enum SyncStatus {
  PENDING
  SYNCED
  FAILED
  NOT_FOUND
}

// ============================================
// USERS & PROFILES
// ============================================

model User {
  id              String    @id @default(uuid())
  keycloakId      String    @unique // ID from Keycloak
  email           String    @unique
  username        String    @unique
  phone           String?
  country         String    @default("VN")
  marketCode      String    @default("VN") // For SEA expansion
  avatarUrl       String?
  emailVerified   Boolean   @default(false)
  phoneVerified   Boolean   @default(false)
  isActive        Boolean   @default(true)
  isSuspended     Boolean   @default(false)
  suspendedReason String?
  lastLoginAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  sellerProfile SellerProfile?
  addresses     Address[]
  cart          Cart?
  buyerOrders   Order[]         @relation("BuyerOrders")
  buyerReviews  Review[]        @relation("BuyerReviews")
  consents      Consent[]
  auditLogs     AuditLog[]      @relation("ActorLogs")
  notifications Notification[]

  @@index([keycloakId])
  @@index([email])
  @@index([marketCode])
}

model SellerProfile {
  id           String       @id @default(uuid())
  userId       String       @unique
  displayName  String?
  description  String?
  tier         SellerTier   @default(BASIC)
  status       SellerStatus @default(PENDING)
  ratingStars  Decimal      @default(0) @db.Decimal(3, 2)
  totalRatings Int          @default(0)
  totalSales   Int          @default(0)
  totalRevenue Decimal      @default(0) @db.Decimal(15, 2)

  // Verification
  isVerified         Boolean   @default(false)
  verifiedAt         DateTime?
  identityDocUrl     String?
  businessDocUrl     String?
  verificationNotes  String?

  // Settings
  shippingPolicy  String?
  returnPolicy    String?
  paymentMethods  String[] // ["COD", "BANK_TRANSFER"]
  vacationMode    Boolean  @default(false)
  vacationMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id])
  listings   Listing[]
  orders     Order[]    @relation("SellerOrders")
  reviews    Review[]   @relation("SellerReviews")
  payouts    Payout[]

  @@index([status])
  @@index([tier])
  @@index([ratingStars])
}

enum SellerTier {
  BASIC
  VERIFIED
  PRO_SHOP
}

enum SellerStatus {
  PENDING
  ACTIVE
  SUSPENDED
  BANNED
}

model Address {
  id          String   @id @default(uuid())
  userId      String
  fullName    String
  phone       String
  addressLine1 String
  addressLine2 String?
  city        String
  province    String
  postalCode  String?
  country     String   @default("VN")
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user   User    @relation(fields: [userId], references: [id])
  orders Order[]

  @@index([userId])
}

// ============================================
// LISTINGS
// ============================================

model Listing {
  id            String        @id @default(uuid())
  sellerId      String
  productId     String
  price         Int           // Price in VND (smallest unit)
  quantity      Int
  soldQuantity  Int           @default(0)
  conditionCode String        // M, NM, EX, GD, LP, PL, PO
  languageCode  String        // en, vi, ja, ko, zh, etc.
  isFoil        Boolean       @default(false)
  isGraded      Boolean       @default(false)
  isSealed      Boolean       @default(false)
  gradingCompany String?
  gradingScore  String?
  comments      String?
  status        ListingStatus @default(DRAFT)
  publishedAt   DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  seller     SellerProfile  @relation(fields: [sellerId], references: [id])
  product    Product        @relation(fields: [productId], references: [id])
  media      ListingMedia[]
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@index([sellerId])
  @@index([productId])
  @@index([status])
  @@index([price])
  @@index([conditionCode])
  @@index([languageCode])
}

enum ListingStatus {
  DRAFT
  ACTIVE
  SOLD
  DISABLED
  DELETED
}

model ListingMedia {
  id        String   @id @default(uuid())
  listingId String
  url       String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
}

// ============================================
// CART & ORDERS
// ============================================

model Cart {
  id        String   @id @default(uuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User       @relation(fields: [userId], references: [id])
  items CartItem[]
}

model CartItem {
  id        String   @id @default(uuid())
  cartId    String
  listingId String
  quantity  Int
  addedAt   DateTime @default(now())

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  listing Listing @relation(fields: [listingId], references: [id])

  @@unique([cartId, listingId])
  @@index([cartId])
}

model Order {
  id               String      @id @default(uuid())
  orderNumber      String      @unique // Human-readable order number
  buyerId          String
  sellerId         String
  shippingAddressId String
  status           OrderStatus @default(PENDING_PAYMENT)
  subtotal         Int         // Items total
  shippingFee      Int         @default(0)
  platformFee      Int         @default(0) // Commission
  totalAmount      Int         // Final total
  currency         String      @default("VND")
  notes            String?

  // Payment
  paymentMethod PaymentMethod?
  paidAt        DateTime?

  // Shipping
  shippedAt        DateTime?
  deliveredAt      DateTime?
  deliveryDeadline DateTime?

  // Completion
  completedAt DateTime?
  cancelledAt DateTime?
  cancelReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  buyer           User          @relation("BuyerOrders", fields: [buyerId], references: [id])
  seller          SellerProfile @relation("SellerOrders", fields: [sellerId], references: [id])
  shippingAddress Address       @relation(fields: [shippingAddressId], references: [id])
  items           OrderItem[]
  shipment        Shipment?
  payment         Payment?
  dispute         Dispute?
  review          Review?

  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([orderNumber])
  @@index([createdAt])
}

enum OrderStatus {
  PENDING_PAYMENT
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  COMPLETED
  CANCELLED
  DISPUTED
  REFUNDED
}

enum PaymentMethod {
  COD
  BANK_TRANSFER
  MOMO
  ZALOPAY
  PAYPAL
}

model OrderItem {
  id            String @id @default(uuid())
  orderId       String
  listingId     String
  productName   String // Snapshot
  price         Int    // Snapshot
  quantity      Int
  conditionCode String // Snapshot
  languageCode  String // Snapshot

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  listing Listing @relation(fields: [listingId], references: [id])

  @@index([orderId])
}

model Shipment {
  id             String    @id @default(uuid())
  orderId        String    @unique
  carrier        String?
  trackingNumber String?
  trackingUrl    String?
  proofUrl       String?   // Photo proof
  shippedAt      DateTime?
  estimatedDelivery DateTime?
  deliveredAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  order Order @relation(fields: [orderId], references: [id])
}

// ============================================
// PAYMENTS
// ============================================

model Payment {
  id             String        @id @default(uuid())
  orderId        String        @unique
  method         PaymentMethod
  amount         Int
  currency       String        @default("VND")
  status         PaymentStatus @default(PENDING)
  idempotencyKey String        @unique
  externalId     String?       // PSP transaction ID
  metadata       Json?
  paidAt         DateTime?
  failedAt       DateTime?
  failureReason  String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  order  Order          @relation(fields: [orderId], references: [id])
  events PaymentEvent[]

  @@index([status])
  @@index([externalId])
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

model PaymentEvent {
  id        String   @id @default(uuid())
  paymentId String
  type      String   // created, processing, completed, failed, refunded
  payload   Json?
  createdAt DateTime @default(now())

  payment Payment @relation(fields: [paymentId], references: [id])

  @@index([paymentId])
}

model Payout {
  id        String       @id @default(uuid())
  sellerId  String
  amount    Int
  currency  String       @default("VND")
  status    PayoutStatus @default(PENDING)
  method    String?      // bank_transfer
  reference String?
  paidAt    DateTime?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  seller SellerProfile @relation(fields: [sellerId], references: [id])

  @@index([sellerId])
  @@index([status])
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================
// REVIEWS & DISPUTES
// ============================================

model Review {
  id        String   @id @default(uuid())
  orderId   String   @unique
  sellerId  String
  buyerId   String
  rating    Int      // 1-5
  comment   String?
  isVisible Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order  Order         @relation(fields: [orderId], references: [id])
  seller SellerProfile @relation("SellerReviews", fields: [sellerId], references: [id])
  buyer  User          @relation("BuyerReviews", fields: [buyerId], references: [id])

  @@index([sellerId])
  @@index([rating])
}

model Dispute {
  id           String        @id @default(uuid())
  orderId      String        @unique
  openedById   String        // User ID who opened
  reason       DisputeReason
  description  String
  status       DisputeStatus @default(OPEN)
  evidenceUrls String[]
  decision     String?
  decisionBy   String?       // Admin user ID
  decisionAt   DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  order Order @relation(fields: [orderId], references: [id])

  @@index([status])
}

enum DisputeReason {
  ITEM_NOT_RECEIVED
  ITEM_NOT_AS_DESCRIBED
  WRONG_ITEM
  DAMAGED
  FAKE_ITEM
  OTHER
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
  CLOSED
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String   // order_created, order_shipped, review_received, etc.
  title     String
  message   String
  data      Json?    // Additional data
  isRead    Boolean  @default(false)
  readAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// ============================================
// COMPLIANCE & AUDIT
// ============================================

model Consent {
  id            String   @id @default(uuid())
  userId        String
  policyVersion String
  policyType    String   // privacy, terms, marketing
  acceptedAt    DateTime @default(now())
  ipAddress     String?
  userAgent     String?

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([policyType])
}

model AuditLog {
  id          String   @id @default(uuid())
  actorId     String?  // User ID, null for system
  actorType   String   // user, admin, system
  action      String   // user.suspend, listing.unpublish, dispute.resolve, etc.
  entityType  String   // user, listing, order, etc.
  entityId    String
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  actor User? @relation("ActorLogs", fields: [actorId], references: [id])

  @@index([actorId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
}
